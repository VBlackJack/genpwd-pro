name: Electron CVE Monitor

on:
  schedule:
    # Run weekly on Monday at 09:00 UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:
    inputs:
      force_check:
        description: 'Force CVE check regardless of cache'
        required: false
        default: 'false'
        type: boolean

permissions:
  contents: read
  issues: write
  security-events: write

jobs:
  check-electron-cves:
    name: Check Electron CVEs
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Get current Electron version
        id: electron-version
        run: |
          ELECTRON_VERSION=$(node -p "require('./package.json').devDependencies.electron.replace('^', '')")
          echo "version=$ELECTRON_VERSION" >> $GITHUB_OUTPUT
          echo "Current Electron version: $ELECTRON_VERSION"

      - name: Check Electron releases for security advisories
        id: check-releases
        run: |
          CURRENT_VERSION="${{ steps.electron-version.outputs.version }}"
          MAJOR_VERSION=$(echo $CURRENT_VERSION | cut -d. -f1)

          echo "Checking Electron v$MAJOR_VERSION.x releases..."

          # Fetch latest releases from Electron GitHub API
          RELEASES=$(curl -s "https://api.github.com/repos/electron/electron/releases?per_page=20")

          # Find latest version in current major
          LATEST_IN_MAJOR=$(echo "$RELEASES" | jq -r --arg major "v$MAJOR_VERSION" \
            '[.[] | select(.tag_name | startswith($major)) | .tag_name] | first // empty' | sed 's/v//')

          if [ -z "$LATEST_IN_MAJOR" ]; then
            echo "Could not find releases for Electron v$MAJOR_VERSION.x"
            LATEST_IN_MAJOR=$CURRENT_VERSION
          fi

          echo "latest_version=$LATEST_IN_MAJOR" >> $GITHUB_OUTPUT
          echo "Latest in v$MAJOR_VERSION.x: $LATEST_IN_MAJOR"

          # Compare versions
          if [ "$CURRENT_VERSION" != "$LATEST_IN_MAJOR" ]; then
            echo "update_available=true" >> $GITHUB_OUTPUT
            echo "::warning::Electron update available: $CURRENT_VERSION -> $LATEST_IN_MAJOR"
          else
            echo "update_available=false" >> $GITHUB_OUTPUT
            echo "Electron is up to date"
          fi

      - name: Fetch Electron security advisories
        id: fetch-advisories
        run: |
          echo "Fetching security advisories from GitHub Advisory Database..."

          # Query GitHub Advisory Database for Electron vulnerabilities
          ADVISORIES=$(curl -s -H "Accept: application/vnd.github+json" \
            "https://api.github.com/advisories?ecosystem=npm&package=electron&per_page=10")

          # Count recent advisories (last 90 days)
          NINETY_DAYS_AGO=$(date -d '90 days ago' +%Y-%m-%d 2>/dev/null || date -v-90d +%Y-%m-%d)
          RECENT_COUNT=$(echo "$ADVISORIES" | jq --arg date "$NINETY_DAYS_AGO" \
            '[.[] | select(.published_at >= $date)] | length')

          echo "recent_advisories=$RECENT_COUNT" >> $GITHUB_OUTPUT
          echo "Found $RECENT_COUNT advisories in last 90 days"

          # Save advisories for report
          echo "$ADVISORIES" | jq '[.[:5] | .[] | {
            id: .ghsa_id,
            severity: .severity,
            summary: .summary,
            published: .published_at,
            url: .html_url
          }]' > advisories.json

      - name: Check for CVEs affecting current version
        id: check-cves
        run: |
          CURRENT_VERSION="${{ steps.electron-version.outputs.version }}"

          # Use npm audit to check for known vulnerabilities
          npm install electron@$CURRENT_VERSION --package-lock-only --ignore-scripts 2>/dev/null || true

          AUDIT_RESULT=$(npm audit --json 2>/dev/null || echo '{"vulnerabilities":{}}')
          VULN_COUNT=$(echo "$AUDIT_RESULT" | jq '.vulnerabilities | length')

          echo "vulnerability_count=$VULN_COUNT" >> $GITHUB_OUTPUT

          if [ "$VULN_COUNT" -gt 0 ]; then
            echo "::error::Found $VULN_COUNT vulnerabilities in current Electron version"
            echo "$AUDIT_RESULT" | jq '.vulnerabilities' > vulnerabilities.json
          fi

      - name: Generate security report
        id: generate-report
        run: |
          cat << 'EOF' > security-report.md
          # Electron Security Report

          **Generated:** $(date -u +"%Y-%m-%d %H:%M UTC")
          **Current Version:** ${{ steps.electron-version.outputs.version }}
          **Latest Available:** ${{ steps.check-releases.outputs.latest_version }}

          ## Update Status
          EOF

          if [ "${{ steps.check-releases.outputs.update_available }}" = "true" ]; then
            echo "âš ï¸ **Update Available**: Electron ${{ steps.check-releases.outputs.latest_version }}" >> security-report.md
          else
            echo "âœ… **Up to Date**" >> security-report.md
          fi

          echo "" >> security-report.md
          echo "## Recent Advisories (Last 90 Days)" >> security-report.md
          echo "" >> security-report.md
          echo "Found ${{ steps.fetch-advisories.outputs.recent_advisories }} advisory/advisories" >> security-report.md
          echo "" >> security-report.md

          if [ -f advisories.json ]; then
            echo "### Latest Advisories" >> security-report.md
            echo "" >> security-report.md
            jq -r '.[] | "- **\(.id)** (\(.severity)): \(.summary) - [View](\(.url))"' advisories.json >> security-report.md
          fi

          echo "" >> security-report.md
          echo "## Vulnerability Scan" >> security-report.md
          echo "" >> security-report.md

          if [ "${{ steps.check-cves.outputs.vulnerability_count }}" -gt 0 ]; then
            echo "ðŸš¨ **Found ${{ steps.check-cves.outputs.vulnerability_count }} vulnerabilities**" >> security-report.md
          else
            echo "âœ… **No known vulnerabilities in current version**" >> security-report.md
          fi

          cat security-report.md

      - name: Create issue if vulnerabilities found
        if: steps.check-cves.outputs.vulnerability_count > 0 || steps.check-releases.outputs.update_available == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('security-report.md', 'utf8');

            // Check for existing open issue
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'security,electron-cve',
              state: 'open'
            });

            if (existingIssues.data.length > 0) {
              // Update existing issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssues.data[0].number,
                body: `## Updated Security Report\n\n${report}`
              });
              console.log('Updated existing security issue');
            } else {
              // Create new issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'ðŸ”’ Electron Security Update Required',
                body: report,
                labels: ['security', 'electron-cve', 'dependencies']
              });
              console.log('Created new security issue');
            }

      - name: Upload security report
        uses: actions/upload-artifact@v4
        with:
          name: electron-security-report
          path: |
            security-report.md
            advisories.json
            vulnerabilities.json
          retention-days: 30

  notify-on-critical:
    name: Notify on Critical CVE
    runs-on: ubuntu-latest
    needs: check-electron-cves
    if: failure()
    steps:
      - name: Send notification
        run: |
          echo "::error::Critical Electron security issue detected. Review the security report immediately."
          # Add Slack/Discord webhook notification here if needed
