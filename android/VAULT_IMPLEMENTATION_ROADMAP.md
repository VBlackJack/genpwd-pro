# üöÄ Vault Management - Implementation Roadmap

Feuille de route pour l'impl√©mentation compl√®te du syst√®me de gestion des vaults bas√© sur fichiers.

**Date d√©but** : 27 octobre 2025
**Version actuelle** : Phase 1 compl√©t√©e ‚úÖ
**Version cible** : v2.6.0
**Branch** : `claude/android-ux-design-011CUXbWzXbED17n7GUmyX47`

---

## ‚úÖ Phase 1: Core Infrastructure (COMPL√âT√âE)

**Status** : ‚úÖ **FAIT** - Commit `0f7187f`
**Dur√©e r√©elle** : Session 1
**Fichiers cr√©√©s** : 6

### Impl√©ment√© :

1. **Data Models** (`data/models/vault/`)
   - ‚úÖ `StorageStrategy.kt` - 4 strat√©gies de stockage
   - ‚úÖ `VaultFileHeader.kt` - Header 256 bytes
   - ‚úÖ `VaultData.kt` - Structures de donn√©es compl√®tes

2. **Database** (`data/local/`)
   - ‚úÖ `VaultRegistryEntry.kt` - Entity pour registre
   - ‚úÖ `VaultRegistryDao.kt` - DAO complet avec transactions

3. **File Manager** (`data/vault/`)
   - ‚úÖ `VaultFileManager.kt` - Gestion fichiers .gpv
   - ‚úÖ Format .gpv d√©fini (Header + Content chiffr√©)
   - ‚úÖ M√©thodes create, load, save, delete, export

### Ce qui fonctionne :

- Structure de base pour fichiers .gpv
- Registre des vaults dans Room DB
- API compl√®te pour op√©rations fichiers

---

## üîÑ Phase 2: Integration & Helpers (EN COURS)

**Status** : üìù √Ä FAIRE
**Estimation** : 1-2 jours
**Priorit√©** : üî¥ HAUTE

### T√¢ches :

#### 2.1 VaultCryptoManager Helpers
**Fichier** : `data/crypto/VaultCryptoManager.kt`

Ajouter m√©thodes helper pour VaultFileManager :

```kotlin
/**
 * G√©n√®re un salt d√©terministe depuis une cha√Æne
 * (pour utiliser vaultId comme base du salt)
 */
fun generateSaltFromString(seed: String): ByteArray {
    val digest = MessageDigest.getInstance("SHA-256")
    return digest.digest(seed.toByteArray(Charsets.UTF_8))
}

/**
 * Chiffre des bytes avec g√©n√©ration automatique d'IV
 * Retourne: IV (12 bytes) + Ciphertext + Tag
 */
fun encryptBytes(plaintext: ByteArray, key: SecretKey): ByteArray {
    val iv = generateIV()
    val encrypted = encryptAESGCM(plaintext, key, iv)
    // Concat: IV + encrypted
    return iv + encrypted
}

/**
 * D√©chiffre des bytes (extrait l'IV automatiquement)
 * Input: IV (12 bytes) + Ciphertext + Tag
 */
fun decryptBytes(ciphertext: ByteArray, key: SecretKey): ByteArray {
    val iv = ciphertext.copyOfRange(0, IV_LENGTH)
    val encrypted = ciphertext.copyOfRange(IV_LENGTH, ciphertext.size)
    return decryptAESGCM(encrypted, key, iv)
}
```

**Test** : V√©rifier chiffrement/d√©chiffrement roundtrip

#### 2.2 Database Migration 5‚Üí6
**Fichier** : `data/local/database/AppDatabase.kt`

```kotlin
// 1. Ajouter VaultRegistryEntry aux entities
@Database(
    entities = [
        ...,
        VaultRegistryEntry::class  // AJOUTER
    ],
    version = 6,  // INCR√âMENTER
    ...
)

// 2. Ajouter DAO
abstract fun vaultRegistryDao(): VaultRegistryDao

// 3. Cr√©er migration
val MIGRATION_5_6 = object : Migration(5, 6) {
    override fun migrate(database: SupportSQLiteDatabase) {
        database.execSQL("""
            CREATE TABLE IF NOT EXISTS vault_registry (
                id TEXT NOT NULL PRIMARY KEY,
                name TEXT NOT NULL,
                filePath TEXT NOT NULL,
                storageStrategy TEXT NOT NULL,
                fileSize INTEGER NOT NULL,
                lastModified INTEGER NOT NULL,
                lastAccessed INTEGER,
                isDefault INTEGER NOT NULL DEFAULT 0,
                isLoaded INTEGER NOT NULL DEFAULT 0,
                entryCount INTEGER NOT NULL DEFAULT 0,
                folderCount INTEGER NOT NULL DEFAULT 0,
                presetCount INTEGER NOT NULL DEFAULT 0,
                tagCount INTEGER NOT NULL DEFAULT 0,
                totalSize INTEGER NOT NULL DEFAULT 0,
                description TEXT,
                createdAt INTEGER NOT NULL
            )
        """)

        database.execSQL("CREATE INDEX IF NOT EXISTS index_vault_registry_isDefault ON vault_registry(isDefault)")
        database.execSQL("CREATE INDEX IF NOT EXISTS index_vault_registry_isLoaded ON vault_registry(isLoaded)")
    }
}
```

#### 2.3 DatabaseModule Update
**Fichier** : `di/DatabaseModule.kt`

```kotlin
@Provides
@Singleton
fun provideVaultRegistryDao(database: AppDatabase): VaultRegistryDao {
    return database.vaultRegistryDao()
}

// Dans provideDatabase, ajouter:
.addMigrations(
    ...,
    AppDatabase.MIGRATION_5_6
)
```

#### 2.4 VaultFileManager Fixes

Mettre √† jour VaultFileManager pour utiliser les nouvelles m√©thodes :

```kotlin
// Dans createVaultFile:
val salt = cryptoManager.generateSaltFromString(vaultId)
val vaultKey = cryptoManager.deriveKey(masterPassword, salt)

// Dans readVaultFile/writeVaultFile:
val encryptedContent = cryptoManager.encryptBytes(dataJson.toByteArray(), vaultKey)
val decryptedBytes = cryptoManager.decryptBytes(encryptedContent, vaultKey)
```

**Test** : Cr√©er, sauvegarder, charger un vault .gpv

---

## üîÑ Phase 3: Migration Manager

**Status** : üìù √Ä FAIRE
**Estimation** : 1 jour
**Priorit√©** : üü° MOYENNE

### T√¢ches :

#### 3.1 VaultMigrationManager
**Fichier** : `data/vault/VaultMigrationManager.kt` (√Ä CR√âER)

```kotlin
@Singleton
class VaultMigrationManager @Inject constructor(
    private val database: AppDatabase,
    private val vaultRepository: VaultRepository,
    private val fileManager: VaultFileManager,
    private val registryDao: VaultRegistryDao
) {
    /**
     * Migre tous les vaults depuis Room vers fichiers .gpv
     */
    suspend fun migrateToFileBasedSystem(
        onProgress: (current: Int, total: Int) -> Unit = { _, _ -> }
    ): MigrationResult

    /**
     * Migre un vault sp√©cifique
     */
    private suspend fun migrateVault(
        vault: VaultEntity,
        masterPassword: String
    ): Boolean

    /**
     * Cr√©e un backup avant migration
     */
    private suspend fun createBackup(): File
}

data class MigrationResult(
    val success: Boolean,
    val migratedCount: Int,
    val failedCount: Int,
    val backupPath: String?,
    val errors: List<String>
)
```

#### 3.2 Migration Flow

1. D√©tecter si migration n√©cessaire (v√©rifier si vault_registry vide)
2. Cr√©er backup de la DB actuelle
3. Pour chaque vault dans `vaults`:
   - Extraire toutes les donn√©es (entries, presets, folders, tags)
   - Cr√©er fichier .gpv avec VaultFileManager
   - Cr√©er entr√©e VaultRegistryEntry
   - Marquer comme migr√©
4. Optionnel : Supprimer anciennes donn√©es (garder pour rollback)

#### 3.3 UI Migration Dialog

Cr√©er dialogue de progression pour migration :
- Progress bar
- "Migration en cours... X/Y vaults"
- Option d'annuler
- Afficher erreurs si √©chec

---

## üé® Phase 4: UI Implementation

**Status** : üìù √Ä FAIRE
**Estimation** : 2-3 jours
**Priorit√©** : üî¥ HAUTE

### T√¢ches :

#### 4.1 VaultManagerViewModel
**Fichier** : `presentation/vault/VaultManagerViewModel.kt` (√Ä CR√âER)

```kotlin
@HiltViewModel
class VaultManagerViewModel @Inject constructor(
    private val registryDao: VaultRegistryDao,
    private val fileManager: VaultFileManager,
    private val vaultRepository: VaultRepository
) : ViewModel() {

    val vaults: StateFlow<List<VaultRegistryEntry>>
    val uiState: StateFlow<VaultManagerUiState>

    fun loadVault(vaultId: String, password: String)
    fun unloadVault(vaultId: String)
    fun deleteVault(vaultId: String)
    fun exportVault(vaultId: String, destinationUri: Uri)
    fun changeVaultLocation(vaultId: String, newStrategy: StorageStrategy)
    fun setAsDefault(vaultId: String)
}
```

#### 4.2 VaultManagerScreen
**Fichier** : `presentation/vault/VaultManagerScreen.kt` (√Ä CR√âER)

UI Components √† cr√©er :
- Liste des vaults avec cards
- Infos : nom, location, taille, nombre d'entr√©es
- Status indicator (loaded/unloaded)
- Actions menu par vault
- FAB pour cr√©er nouveau vault
- Confirmation dialogs (delete, export)

#### 4.3 CreateVaultDialog Enhancement

Modifier le dialogue existant pour ajouter :
- Choix de StorageStrategy (RadioButtons)
- Explication de chaque strat√©gie
- Warning pour strat√©gies non s√©curis√©es

#### 4.4 Navigation Integration

Ajouter route dans NavGraph :
```kotlin
object VaultManager : Screen("vault_manager")
```

---

## üöÄ Phase 5: Advanced Features

**Status** : üìù √Ä FAIRE
**Estimation** : 2-3 jours
**Priorit√©** : üü¢ BASSE

### T√¢ches :

#### 5.1 Export/Import UI

- File picker pour destination export
- Import depuis fichier externe
- Validation de fichier .gpv
- Gestion conflits (vault d√©j√† existant)

#### 5.2 Vault Properties Screen

√âcran de d√©tails vault :
- M√©tadonn√©es compl√®tes
- Statistiques d√©taill√©es
- Historique d'acc√®s
- Taille par cat√©gorie (entries/presets/folders)
- Changer nom, description
- Changer ic√¥ne/couleur

#### 5.3 Storage Strategy Migration

Permettre de changer la strat√©gie de stockage d'un vault existant :
- Copier fichier vers nouveau location
- Mettre √† jour registry
- Supprimer ancien fichier
- Rollback si √©chec

#### 5.4 Backup/Restore

- Backup automatique avant op√©rations risqu√©es
- Restore depuis backup
- UI pour g√©rer backups
- Nettoyage ancien backups

#### 5.5 Vault Duplication

- Dupliquer un vault existant
- Nouveau master password
- Nouveau fichier .gpv
- Utile pour testing ou backup

---

## üß™ Phase 6: Testing & Polish

**Status** : üìù √Ä FAIRE
**Estimation** : 2 jours
**Priorit√©** : üî¥ HAUTE

### T√¢ches :

#### 6.1 Unit Tests

Fichiers √† tester :
- `VaultFileManagerTest.kt`
  - Create/Load/Save roundtrip
  - Encryption/Decryption
  - Format validation
  - Checksum verification

- `VaultRegistryDaoTest.kt`
  - CRUD operations
  - Default vault management
  - Loaded status tracking

- `VaultMigrationManagerTest.kt`
  - Migration success
  - Migration rollback
  - Backup creation

#### 6.2 Integration Tests

- Cr√©er vault ‚Üí Sauvegarder ‚Üí Recharger
- Migration compl√®te ancien syst√®me
- Export ‚Üí Import roundtrip
- Changement de strat√©gie de stockage

#### 6.3 UI Tests

- Navigation VaultManagerScreen
- Cr√©ation vault avec diff√©rentes strat√©gies
- Actions menu (delete, export, etc.)
- Migration dialog flow

#### 6.4 Performance Tests

- Load time pour gros vaults (1000+ entries)
- Memory usage avec plusieurs vaults charg√©s
- File I/O performance
- Encryption/Decryption speed

#### 6.5 Security Audit

- V√©rifier keys jamais √©crites sur disque
- File permissions correctes
- Checksum validation
- IV uniqueness

---

## üìã Checklist Compl√®te

### Phase 1 ‚úÖ
- [x] StorageStrategy enum
- [x] VaultFileHeader, VaultData models
- [x] VaultRegistryEntry entity
- [x] VaultRegistryDao
- [x] VaultFileManager skeleton

### Phase 2 (Integration)
- [ ] VaultCryptoManager helpers
- [ ] Database migration 5‚Üí6
- [ ] DatabaseModule update
- [ ] VaultFileManager fixes
- [ ] Test create/load/save vault

### Phase 3 (Migration)
- [ ] VaultMigrationManager
- [ ] Backup creation
- [ ] Migration flow
- [ ] Migration UI dialog
- [ ] Test migration

### Phase 4 (UI)
- [ ] VaultManagerViewModel
- [ ] VaultManagerScreen
- [ ] CreateVaultDialog enhancement
- [ ] Navigation integration
- [ ] Test UI flow

### Phase 5 (Advanced)
- [ ] Export/Import UI
- [ ] Vault Properties Screen
- [ ] Storage Strategy Migration
- [ ] Backup/Restore
- [ ] Vault Duplication

### Phase 6 (Testing)
- [ ] Unit tests (3 fichiers)
- [ ] Integration tests
- [ ] UI tests
- [ ] Performance tests
- [ ] Security audit

---

## üéØ Quick Start - Phase 2

Pour continuer l'impl√©mentation, commencer par Phase 2:

1. **Ajouter helpers √† VaultCryptoManager** :
   ```bash
   # √âditer: data/crypto/VaultCryptoManager.kt
   # Ajouter: generateSaltFromString, encryptBytes, decryptBytes
   ```

2. **Migrer database 5‚Üí6** :
   ```bash
   # √âditer: data/local/database/AppDatabase.kt
   # Incr√©menter version √† 6
   # Ajouter MIGRATION_5_6
   ```

3. **Tester** :
   ```kotlin
   // Cr√©er un simple test
   val fileManager = VaultFileManager(context, cryptoManager)
   val (vaultId, file) = fileManager.createVaultFile(
       "Test Vault",
       "password123",
       StorageStrategy.APP_STORAGE
   )
   println("Vault created: ${file.absolutePath}")
   ```

---

## üìä Progression

| Phase | Status | Completion | Time Spent | Time Remaining |
|-------|--------|------------|------------|----------------|
| Phase 1 | ‚úÖ Done | 100% | 1 session | 0 |
| Phase 2 | üìù Todo | 0% | 0 | 1-2 days |
| Phase 3 | üìù Todo | 0% | 0 | 1 day |
| Phase 4 | üìù Todo | 0% | 0 | 2-3 days |
| Phase 5 | üìù Todo | 0% | 0 | 2-3 days |
| Phase 6 | üìù Todo | 0% | 0 | 2 days |
| **TOTAL** | **8%** | **8/100%** | **1 session** | **8-11 days** |

---

## üí° Notes Importantes

### Compatibilit√© Ascendante

L'ancien syst√®me Room continue de fonctionner. La migration est optionnelle.
Strat√©gie : Double syst√®me temporaire, puis migration progressive.

### S√©curit√©

- Les fichiers .gpv sont chiffr√©s avec AES-256-GCM
- Master password requis pour chaque acc√®s
- Keys jamais persist√©es sur disque
- Format ouvert mais secure

### Performance

- Lazy loading : charger seulement vaults actifs
- Cache en m√©moire pour vaults utilis√©s fr√©quemment
- Timeout automatique pour unload

### Backup

Toujours cr√©er backup avant :
- Migration
- Suppression vault
- Changement strat√©gie stockage

---

ü§ñ G√©n√©r√© avec [Claude Code](https://claude.com/claude-code)

**Derni√®re mise √† jour** : Phase 1 compl√©t√©e
**Prochain milestone** : Phase 2 Integration
